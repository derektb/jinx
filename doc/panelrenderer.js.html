<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: panelrenderer.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: panelrenderer.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var $ = require('jquery');
var _ = require('underscore');
const ShadowPanel = require('ShadowPanel');
const StepAnimation = require('StepAnimation');
const ShadowAsset = require('ShadowAsset');

/**
 @module PanelRenderer
 @class PanelRenderer
 @constructor
*/
var PanelRenderer = function() {
  var _renderer = this;

  /**
    A unique 10-digit base32 ID which the {@link PanelRenderer} uses to identify itself when triggering events.
    @type String
  */
  this.id = _.thumbprint(10);

  /**
   The assetRecords are the records of instantiated assets, held in a shadow panel.  This is the master model for instantiated asset and layer records.
  **/
  this.assetRecords = new ShadowPanel();
    this.assetRecords.rendererId = this.id;

  this.updateAssetRecords = function(panel) {
    if (panel instanceof ShadowPanel) {
      this.assetRecords = panel;
    } else {
      throw new Error("updateAssetRecords must be passed a ShadowPanel")
    }
  }

  this.refresh = function() {
    this.assetRecords = new ShadowPanel();
    this.assetRecords.rendererId = this.id;
  }

  /* DOM MANIPULATION */

  /**
   getArtAsset allows the PanelRenderer to grab paths for artAssets from the panel.  The panel extends panel.renderer with its own art object when it gets created via a property called panelARtAssets.

   @property panelArtAssets
   @memberof PanelRenderer
   @instance
  **/
  this.panelArtAssets = undefined;

  /**
   getArtAsset allows the PanelRenderer to grab paths for artAssets from the panel.  The panel extends panel.renderer with its own art object when it gets created via a property called panelARtAssets.

   @method getArtAsset
  **/
  this.getArtAsset = function(ref) {
    var name = (ref instanceof ShadowAsset) ? ref.name : ref;
    return this.panelArtAssets[name];
  }

  /**
    The panel's selectors, provided during Panelization.

    @property selectors {object}
  **/
  this.selectors = {
    passage: null,
    panel: null
  };

  this.getArtElement = function(ref){
    var rName, rLayer, rId, sEl, element;

    if (_(ref).hasAll(["name","layer","id"])) {
      rName = ref.name;
      rLayer = ref.layer;
      rId = ref.id;
    }

    sEl = this.selectors.panel + " .asset[assetId='"+rId+"']";
    element = document.querySelector(sEl);

    if(!element &amp;&amp; (rName &amp;&amp; rLayer &amp;&amp; rId)) {
      element = this.createArtElement(ref);
    }

    return element;
  }

  this.createArtElement = function(ref) {
    var artAsset = this.getArtAsset(ref.name);
    var element, image, layerSel;

    switch (artAsset.type) {
      case 'image':
        element = document.createElement('img');
        image = element;
        break;
      case 'asset':
        element = document.createElement('div');
        // if artAsset.tags has "css" then we do a css background, otherwise:
        image = document.createElement('img');
        element.appendChild(image);
        break;
      default:
        throw new Error("Unknown type of art asset: '"+artAsset.type+"'");
    }

    image.setAttribute('src', artAsset.getSrc());
    element.setAttribute('assetid', ref.id);
    element.setAttribute('assetname', ref.name);

    var loadHandler = function(e){
      image.removeEventListener("load", loadHandler); image.removeEventListener("error", loadErrorHandler);

      element.setAttribute('loaded','loaded');
      _renderer.assetRecords.assetLoaded(ref);
    }
    var loadErrorHandler = function(e){
      image.removeEventListener("load", loadHandler); image.removeEventListener("error", loadErrorHandler);

      _renderer.assetRecords.assetLoadError(ref);
    }

    image.addEventListener("load", loadHandler);
    image.addEventListener("error", loadErrorHandler);
    element.className = "asset";

    layerSel = this.selectors.panel + " .layer."+ref.layer;
    $(layerSel).append(element);
    _renderer.assetRecords.assetInstantiated(ref);

    return element;
  }

  this.destroyArtElement = function(element) {
    // console.log("Removing element:",element);
    element.parentNode.removeChild(element);
    element = null; // unknown if this is actually how to do it, unknown if memory will leak with this.
    // console.log(element);
  }

  /* ANIMATION PIPELINE FUNCTIONS */

  /**
    Handles panel animation.  This requires a lot of documentation, so suffice it to say, I'm sorry it doesn't exist.

    @method animate
    @param stepAnimation {StepAnimation} passed a StepAnimation, generated by Panel.advance()
    @see Panel.advance
  */
  this.animate = function(stepAnimation) {
    var sequences = [];
    /**
      Triggers when PanelRenderer.animate() begins playing.
    @event animation-begun
    @see PanelRenderer.animate
    **/
    $(document).trigger("animation-begun", stepAnimation);

    // create a promise on the assetrecords that will resolve once all images have loaded

    // create snabbt sequences
    _(stepAnimation.assets).each(_(function(assetAnimation) {
      var element, sequence;
      element = this.getArtElement(assetAnimation.asset);
      sequence = this.createSnabbtSequence(assetAnimation, element);
      sequences.push(sequence);
    }).bind(this));
    debugger
    // HACK:
    var loads = _renderer.assetRecords._loadingAssets.length ? true : false; // this is just a quick fix

    // play all snabbt sequences
    function playAnimation() {
      $(document).trigger("started-playing-animation");
      // console.log("all assets have loaded", Date.now(), _renderer.assetRecords)
      // HACK: Refactor this to be an actual function
      _(sequences).each(function(sequence) {
        snabbt.sequence(sequence);
      })
      setTimeout(function() { $(document).trigger("ended-playing-animation"); }, stepAnimation.timing.totalTime) // HACK: don't like setTimeout for this
    }

    var handler = function(e,data) {
      if (data.rendererId === _renderer.id) {
        playAnimation();
        $(document).off('all-assets-loaded', handler)
      }
    }

    // console.log("assets are created but not loaded yet", Date.now(), _renderer.assetRecords)
    if (loads) {
      $(document).on('all-assets-loaded', handler)
    }  else {
      playAnimation();
    }
  }

  /**
   Parses an array of seqels (a 'step') and returns a StepAnimation.

   @method createStepAnimation
  **/

  this.createStepAnimation = function(step) {
    var stepAnimation;
    var panel = this.assetRecords;

    stepAnimation = new StepAnimation(step, this.assetRecords);

    _(step).forEach(function(seqel){
      if(seqel.apply === "add") {
        stepAnimation.addArtToLayer(seqel);
      } else if (seqel.apply === "remove") {
        if(seqel.art) {
          stepAnimation.removeArtFromLayer(seqel);
        } else {
          stepAnimation.removeAllArtFromLayer(seqel);
        }
      } else if (seqel.apply === "replace") {
        stepAnimation.removeAllArtFromLayer(seqel);
        var fauxSeqel = _.clone(seqel)
        fauxSeqel.delay = 0;
        fauxSeqel.sync = 'with';
        stepAnimation.addArtToLayer(fauxSeqel)
      }
    });

    return stepAnimation;
  }

  this.createSnabbtSequence = function(assetAnimation, element) {
    var beats, sequence, i;

    sequence = [];
    beats = assetAnimation.beats;

    for (i = 0; i &lt; beats.length; i++) {
      var hash = {};
      var beat, previousBeat;
      var start, end, previousEnd, duration;

      beat = beats[i];
        start = beat.startTime;
        end = beat.endTime;

      previousEnd = i ? beats[i-1].endTime : 0;

      hash.delay = start - previousEnd;
      hash.duration = beat.duration;
      hash.easing = window.twize.getDefault("easing");

      switch (beat.action) {
        case "add":
          hash.fromOpacity = 0;
          hash.opacity = 1;
          break;
        case "remove":
          hash.fromOpacity = 1;
          hash.opacity = 0;
          hash.complete = function() { _renderer.destroyArtElement(element); }
          break;
        default:
          break;
      }

      // sequence.push( element, _(hash).clone() ); // unclear if this is necessary
      sequence.push([element, hash]);
    }

    return sequence;
  }
}

module.exports = PanelRenderer;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ArtAsset.html">ArtAsset</a></li><li><a href="PanelRenderer.html">PanelRenderer</a></li><li><a href="Seqel.html">Seqel</a></li><li><a href="Sequence.html">Sequence</a></li><li><a href="Story.html">Story</a></li><li><a href="Twize.html">Twize</a></li></ul><h3>Events</h3><ul><li><a href="global.html#event:animation-begun">animation-begun</a></li><li><a href="global.html#event:checkpoint">checkpoint</a></li><li><a href="global.html#event:checkpointfailed">checkpointfailed</a></li><li><a href="global.html#event:hidepassage">hidepassage</a></li><li><a href="global.html#event:restore">restore</a></li><li><a href="global.html#event:restorefailed">restorefailed</a></li><li><a href="global.html#event:save">save</a></li><li><a href="global.html#event:showpassage">showpassage</a></li><li><a href="global.html#event:startstory">startstory</a></li><li><a href="global.html#event:restore:after">restore:after</a></li><li><a href="global.html#event:showpassage:after">showpassage:after</a></li></ul><h3>Namespaces</h3><ul><li><a href="-_.html">_</a></li></ul><h3>Mixins</h3><ul><li><a href="Underscore.hasAll.html">hasAll</a></li><li><a href="Underscore.hasOnly.html">hasOnly</a></li><li><a href="Underscore.xor.html">xor</a></li><li><a href="Underscore-thumbprint.html">thumbprint</a></li></ul><h3>Global</h3><ul><li><a href="global.html#__parentPassage">__parentPassage</a></li><li><a href="global.html#__selectors">__selectors</a></li><li><a href="global.html#__settings">__settings</a></li><li><a href="global.html#_getDisplayed">_getDisplayed</a></li><li><a href="global.html#_layers">_layers</a></li><li><a href="global.html#_loadingAssets">_loadingAssets</a></li><li><a href="global.html#addArt">addArt</a></li><li><a href="global.html#addArtAssets">addArtAssets</a></li><li><a href="global.html#addBeatPushesanewsequencebeattotheAssetAnimation'ssequence.">addBeat

   Pushes a new sequence beat to the AssetAnimation's sequence.</a></li><li><a href="global.html#addLayer">addLayer</a></li><li><a href="global.html#addLayers">addLayers</a></li><li><a href="global.html#addSeqeltheSeqelconstructortakesvariablearguments,sothisbasicSeqel-makerdoestoo.---2arguments:---">addSeqel
   the Seqel constructor takes variable arguments, so this basic Seqel-maker
   does too.
   --- 2 arguments: ---</a></li><li><a href="global.html#addStep">addStep</a></li><li><a href="global.html#addUnknownLayers">addUnknownLayers</a></li><li><a href="global.html#advance">advance</a></li><li><a href="global.html#animate">animate</a></li><li><a href="global.html#art">art</a></li><li><a href="global.html#asset">asset</a></li><li><a href="global.html#assetFindsthefirstinstanceofanassetmatchingthequeryparamanywhereintheShadowPanel.">asset

   Finds the first instance of an asset matching the query param anywhere in the ShadowPanel.</a></li><li><a href="global.html#assetRecords">assetRecords</a></li><li><a href="global.html#beats">beats</a></li><li><a href="global.html#checkpoint">checkpoint</a></li><li><a href="global.html#checkpointName">checkpointName</a></li><li><a href="global.html#createLayerInstanceSpecializedlayercreation.">createLayerInstance

   Specialized layer creation.</a></li><li><a href="global.html#createStepAnimation">createStepAnimation</a></li><li><a href="global.html#creator">creator</a></li><li><a href="global.html#creatorVersion">creatorVersion</a></li><li><a href="global.html#destination">destination</a></li><li><a href="global.html#errorMessage">errorMessage</a></li><li><a href="global.html#getArtAsset">getArtAsset</a></li><li><a href="global.html#getDefault">getDefault</a></li><li><a href="global.html#history">history</a></li><li><a href="global.html#id">id</a></li><li><a href="global.html#ignoreErrors">ignoreErrors</a></li><li><a href="global.html#ignoreRoot">ignoreRoot</a></li><li><a href="global.html#layerGetsalayerfromtheshadowPanel.">layer

   Gets a layer from the shadowPanel.</a></li><li><a href="global.html#layerize">layerize</a></li><li><a href="global.html#layers">layers</a></li><li><a href="global.html#name">name</a></li><li><a href="global.html#panelize">panelize</a></li><li><a href="global.html#passage">passage</a></li><li><a href="global.html#passageDomName">passageDomName</a></li><li><a href="global.html#passages">passages</a></li><li><a href="global.html#pos">pos</a></li><li><a href="global.html#remove">remove</a></li><li><a href="global.html#render">render</a></li><li><a href="global.html#renderer">renderer</a></li><li><a href="global.html#rendererId">rendererId</a></li><li><a href="global.html#replace">replace</a></li><li><a href="global.html#restore">restore</a></li><li><a href="global.html#save">save</a></li><li><a href="global.html#saveHash">saveHash</a></li><li><a href="global.html#selectors">selectors</a></li><li><a href="global.html#seq">seq</a></li><li><a href="global.html#setDefaults">setDefaults</a></li><li><a href="global.html#setup">setup</a></li><li><a href="global.html#setupStructure">setupStructure</a></li><li><a href="global.html#show">show</a></li><li><a href="global.html#source">source</a></li><li><a href="global.html#start">start</a></li><li><a href="global.html#startPassage">startPassage</a></li><li><a href="global.html#state">state</a></li><li><a href="global.html#step">step</a></li><li><a href="global.html#tags">tags</a></li><li><a href="global.html#tracks">tracks</a></li><li><a href="global.html#userScripts">userScripts</a></li><li><a href="global.html#userStyles">userStyles</a></li><li><a href="global.html#wandize">wandize</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Thu Mar 16 2017 12:58:43 GMT-0700 (Pacific Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
